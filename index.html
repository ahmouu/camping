<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CampCount V4 (Mobile)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ–æ¨£å¼ */
        .container { max-width: 600px; padding: 0; } /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œæ¨¡æ“¬ App è³ªæ„Ÿ */
        .mobile-header {
            background-color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* åˆ†é æŒ‰éˆ•æ¨£å¼ */
        .nav-pills .nav-link {
            border-radius: 50px;
            color: #6c757d;
            font-weight: 500;
            padding: 8px 15px;
            margin: 0 2px;
            font-size: 0.9rem;
        }
        .nav-pills .nav-link.active {
            background-color: #198754; /* ç¶ è‰²ä¸»è‰²èª¿ */
            color: white;
            font-weight: bold;
        }
        
        /* å¡ç‰‡èˆ‡åˆ—è¡¨å„ªåŒ– */
        .content-area { padding: 15px; padding-bottom: 80px; }
        .card { border-radius: 12px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.03); margin-bottom: 15px; }
        .form-control, .form-select, .btn { height: 48px; border-radius: 10px; font-size: 16px; } /* åŠ å¤§è§¸æ§å€ */
        .btn-sm { height: 32px; font-size: 13px; }
        
        /* åˆ—è¡¨é …ç›® */
        .list-group-item {
            border: none;
            border-bottom: 1px solid #f0f0f0;
            padding: 12px 5px;
            background: transparent;
        }

        /* çµç®—æ•¸å­—é¡è‰² */
        .balance-plus { color: #198754; font-weight: bold; background: #e8f5e9; padding: 2px 8px; border-radius: 4px; }
        .balance-minus { color: #dc3545; font-weight: bold; background: #fdecea; padding: 2px 8px; border-radius: 4px; }
        
        /* è¼‰å…¥å‹•ç•« */
        .spinner-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loadingOverlay" class="spinner-overlay">
    <div class="spinner-border text-success" role="status"></div>
</div>

<div class="container">

    <div id="page-list">
        <div class="bg-success text-white p-4 mb-3 text-center" style="border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;">
            <h2 class="fw-bold m-0">â›º CampCount</h2>
            <small class="opacity-75">è¼•é¬†ç´€éŒ„éœ²ç‡Ÿé–‹æ”¯</small>
        </div>

        <div class="px-3">
            <div class="card p-3 mb-4">
                <h6 class="fw-bold text-secondary mb-3">ğŸ“… å»ºç«‹æ–°æ´»å‹•</h6>
                <div class="row g-2">
                    <div class="col-6"><input type="date" id="newStartDate" class="form-control"></div>
                    <div class="col-6"><input type="date" id="newEndDate" class="form-control"></div>
                    <div class="col-12"><input type="text" id="newLoc" class="form-control" placeholder="è¼¸å…¥åœ°é» (ä¾‹: è‹—æ —æ˜Ÿç©º)"></div>
                    <div class="col-12"><button onclick="createTrip()" class="btn btn-dark w-100 fw-bold">ï¼‹ å»ºç«‹æ´»å‹•</button></div>
                </div>
            </div>
            
            <h6 class="ms-1 text-muted fw-bold">æ­·å²ç´€éŒ„</h6>
            <div id="tripList" class="list-group pb-5"></div>
        </div>
    </div>

    <div id="page-detail" style="display: none;">
        
        <div class="mobile-header">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <button onclick="showList()" class="btn btn-outline-secondary btn-sm rounded-pill px-3">â† è¿”å›</button>
                <div class="text-center" style="line-height: 1.2;">
                    <strong id="detailTitle" class="d-block fs-5"></strong>
                    <small id="detailDate" class="text-muted" style="font-size: 0.75rem;"></small>
                </div>
                <button onclick="deleteCurrentTrip()" class="btn btn-light text-danger btn-sm rounded-circle" style="width:32px; height:32px;">ğŸ—‘ï¸</button>
            </div>

            <ul class="nav nav-pills nav-fill" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-people">ğŸ‘¥ äººå“¡</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-expense">ğŸ’° è¨˜å¸³</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-gear">â›º è£å‚™</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-balance">ğŸ§® çµç®—</button></li>
            </ul>
        </div>

        <div class="tab-content content-area" id="myTabContent">
            
            <div class="tab-pane fade show active" id="tab-people">
                <div class="card p-3">
                    <label class="form-label fw-bold">æ–°å¢åƒåŠ è€…</label>
                    <div class="input-group mb-3">
                        <input type="text" id="newPerson" class="form-control" placeholder="è¼¸å…¥å§“å">
                        <button onclick="addParticipant()" class="btn btn-primary px-4">åŠ å…¥</button>
                    </div>
                    <div class="alert alert-light border small text-muted">
                        ğŸ’¡ æç¤ºï¼šè«‹å…ˆåŠ å…¥æ‰€æœ‰äººå“¡ï¼Œæ‰èƒ½é–‹å§‹è¨˜å¸³å–”ï¼
                    </div>
                </div>
                <h6 class="fw-bold ms-1">åƒåŠ åå–®</h6>
                <div id="participantList" class="d-flex flex-column gap-2"></div>
            </div>

            <div class="tab-pane fade" id="tab-expense">
                <div class="card p-3 bg-white">
                    <label class="form-label fw-bold">æ–°å¢ä¸€ç­†æ”¯å‡º</label>
                    <div class="row g-2">
                        <div class="col-8"><input type="text" id="expItem" class="form-control" placeholder="å“é … (å¦‚: é£Ÿæ)"></div>
                        <div class="col-4"><input type="number" inputmode="numeric" id="expCost" class="form-control" placeholder="$é‡‘é¡"></div>
                        <div class="col-12"><select id="expPayer" class="form-select text-center fw-bold text-success"><option>èª°ä»˜éŒ¢?</option></select></div>
                        <div class="col-12"><button onclick="addExpense()" class="btn btn-success w-100">ï¼‹ å„²å­˜æ”¯å‡º</button></div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-end mb-2 px-1">
                    <h6 class="fw-bold m-0">æ”¯å‡ºæ˜ç´°</h6>
                    <small class="text-muted">ç¸½æ”¯å‡º: $<span id="miniTotal">0</span></small>
                </div>
                <ul id="expenseList" class="list-group bg-white rounded-3 shadow-sm"></ul>
            </div>

            <div class="tab-pane fade" id="tab-gear">
                <div class="card p-3">
                    <label class="form-label fw-bold">ç™»è¨˜å…¬ç”¨è£å‚™</label>
                    <div class="row g-2">
                        <div class="col-8"><input type="text" id="gearItem" class="form-control" placeholder="è£å‚™åç¨±"></div>
                        <div class="col-4"><input type="number" inputmode="numeric" id="gearQty" class="form-control" placeholder="æ•¸é‡" value="1"></div>
                        <div class="col-12"><select id="gearProvider" class="form-select text-center fw-bold text-info"><option>èª°æä¾›?</option></select></div>
                        <div class="col-12"><button onclick="addGear()" class="btn btn-info text-white w-100">ï¼‹ åŠ å…¥æ¸…å–®</button></div>
                    </div>
                </div>
                <h6 class="fw-bold ms-1">è£å‚™æ¸…å–®</h6>
                <ul id="gearList" class="list-group bg-white rounded-3 shadow-sm"></ul>
            </div>

            <div class="tab-pane fade" id="tab-balance">
                <div class="card p-4 text-center mb-3" style="background: #e9ecef;">
                    <h1 class="display-4 fw-bold text-dark">$<span id="totalCost">0</span></h1>
                    <p class="text-muted mb-0">ç¸½æ”¯å‡º / <span id="peopleCountDisplay">0</span> äºº</p>
                    <div class="mt-2 badge bg-dark fs-6">å¹³å‡æ¯äºº $<span id="avgCost">0</span></div>
                </div>

                <div class="card p-0 overflow-hidden">
                    <div class="card-header bg-white fw-bold py-3">ğŸ’° çµç®—è¡¨ (å¤šé€€å°‘è£œ)</div>
                    <ul id="balanceList" class="list-group list-group-flush"></ul>
                </div>
            </div>

        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, arrayUnion, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ---------------------------------------------------------
    // ğŸ”¥ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Firebase Config
    // ---------------------------------------------------------
    const firebaseConfig = {
    apiKey: "AIzaSyDURgPj3n3Sbf1LJ9UUYdIZgogx1PB3RFA",
    authDomain: "campapp-1ef27.firebaseapp.com",
    projectId: "campapp-1ef27",
    storageBucket: "campapp-1ef27.firebasestorage.app",
    messagingSenderId: "675381855392",
    appId: "1:675381855392:web:3168fa7bd761b46d95f5c5",
    measurementId: "G-8NEWVV6BBN"
  };
    // ---------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentTripId = null;
    let currentTripData = null;

    // å…¨åŸŸç¶å®š
    window.createTrip = createTrip;
    window.showList = showList;
    window.addParticipant = addParticipant;
    window.addExpense = addExpense;
    window.addGear = addGear;
    window.togglePaid = togglePaid;
    window.deleteExpense = deleteExpense;
    window.deleteParticipant = deleteParticipant;
    window.deleteGear = deleteGear;
    window.deleteCurrentTrip = deleteCurrentTrip;

    // UI Loading æ§åˆ¶
    const toggleLoading = (show) => document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';

    // 1. åˆ—è¡¨ç›£è½
    onSnapshot(collection(db, "trips"), (snapshot) => {
        const listEl = document.getElementById('tripList');
        listEl.innerHTML = "";
        
        let trips = [];
        snapshot.forEach(doc => trips.push({id: doc.id, ...doc.data()}));
        trips.sort((a, b) => new Date(b.startDate || b.date) - new Date(a.startDate || a.date));

        const today = new Date();
        today.setHours(0,0,0,0);

        trips.forEach(trip => {
            const start = trip.startDate || trip.date;
            const end = trip.endDate || trip.date;
            const isFinished = new Date(end) < today;
            
            const statusBadge = isFinished 
                ? `<span class="badge bg-secondary">å·²çµæŸ</span>` 
                : `<span class="badge bg-success">é€²è¡Œä¸­</span>`;

            listEl.innerHTML += `
                <div onclick="window.loadTrip('${trip.id}')" class="card p-3 mb-2 shadow-sm" style="cursor:pointer; border-left: 5px solid ${isFinished ? '#6c757d' : '#198754'}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold mb-1 text-dark">${trip.location}</h5>
                            <small class="text-muted">ğŸ“… ${start} ~ ${end}</small>
                        </div>
                        <div class="text-end">
                            ${statusBadge}
                            <div class="text-muted small mt-1"> > </div>
                        </div>
                    </div>
                </div>`;
        });
    });

    // 2. å»ºç«‹
    async function createTrip() {
        const start = document.getElementById('newStartDate').value;
        const end = document.getElementById('newEndDate').value;
        const loc = document.getElementById('newLoc').value;
        
        if(!start || !end || !loc) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
        if(start > end) return alert("çµæŸæ—¥æœŸéŒ¯èª¤");

        toggleLoading(true);
        await addDoc(collection(db, "trips"), {
            startDate: start, endDate: end, date: start, location: loc,
            participants: [], expenses: [], gears: []
        });
        document.getElementById('newLoc').value = '';
        toggleLoading(false);
    }

    async function deleteCurrentTrip() {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤æ•´å€‹æ´»å‹•ï¼Ÿç„¡æ³•å¾©åŸï¼")) return;
        toggleLoading(true);
        await deleteDoc(doc(db, "trips", currentTripId));
        toggleLoading(false);
        showList();
    }

    // 3. è¼‰å…¥è©³æƒ…
    window.loadTrip = function(id) {
        currentTripId = id;
        document.getElementById('page-list').style.display = 'none';
        document.getElementById('page-detail').style.display = 'block';
        window.scrollTo(0,0);
        
        // é‡ç½® Tabs åˆ°ç¬¬ä¸€å€‹
        const firstTab = new bootstrap.Tab(document.querySelector('#myTab button[data-bs-target="#tab-people"]'));
        firstTab.show();

        onSnapshot(doc(db, "trips", id), (docSnap) => {
            if (!docSnap.exists()) { showList(); return; }
            currentTripData = docSnap.data();
            renderDetail();
        });
    }

    function showList() {
        document.getElementById('page-list').style.display = 'block';
        document.getElementById('page-detail').style.display = 'none';
        currentTripId = null;
    }

    function renderDetail() {
        const d = currentTripData;
        document.getElementById('detailTitle').innerText = d.location;
        document.getElementById('detailDate').innerText = `${d.startDate || d.date} ~ ${d.endDate || d.date}`;

        // ä¸‹æ‹‰é¸å–®
        const payerSelect = document.getElementById('expPayer');
        const gearSelect = document.getElementById('gearProvider');
        const savedPayer = payerSelect.value;
        
        payerSelect.innerHTML = '<option disabled selected>èª°ä»˜éŒ¢?</option>';
        gearSelect.innerHTML = '<option disabled selected>èª°æä¾›?</option>';
        
        // 1. äººå“¡åå–®
        const pList = document.getElementById('participantList');
        pList.innerHTML = '';
        d.participants.forEach((p, idx) => {
            pList.innerHTML += `
                <div class="card p-3 mb-1 d-flex flex-row justify-content-between align-items-center shadow-sm">
                    <span class="fw-bold fs-5">${p.name}</span>
                    <button onclick="deleteParticipant(${idx})" class="btn btn-outline-danger btn-sm rounded-pill">ç§»é™¤</button>
                </div>`;
            payerSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`;
            gearSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`;
        });
        if(savedPayer && savedPayer !== 'èª°ä»˜éŒ¢?') payerSelect.value = savedPayer;

        // 2. æ”¯å‡ºåå–®
        const expList = document.getElementById('expenseList');
        const totalCost = d.expenses.reduce((sum, e) => sum + Number(e.cost), 0);
        document.getElementById('miniTotal').innerText = totalCost; // å°è¨ˆé¡¯ç¤º
        
        expList.innerHTML = d.expenses.length ? '' : '<li class="text-center py-4 text-muted">å°šæœªæœ‰æ”¯å‡ºç´€éŒ„</li>';
        d.expenses.forEach((e, idx) => {
            expList.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold fs-5">${e.item}</div>
                        <small class="text-muted">ç”± ${e.payer} æ”¯ä»˜</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">$${e.cost}</div>
                        <button onclick="deleteExpense(${idx})" class="btn btn-link text-danger p-0 small text-decoration-none" style="font-size:12px">åˆªé™¤</button>
                    </div>
                </li>`;
        });

        // 3. è£å‚™åå–®
        const gList = document.getElementById('gearList');
        gList.innerHTML = d.gears.length ? '' : '<li class="text-center py-4 text-muted">å°šæœªæœ‰è£å‚™ç´€éŒ„</li>';
        d.gears.forEach((g, idx) => {
            gList.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold">${g.item}</span> <span class="badge bg-secondary rounded-pill">x${g.quantity || 1}</span>
                        <div class="small text-info">${g.provider} æä¾›</div>
                    </div>
                    <button onclick="deleteGear(${idx})" class="btn btn-sm btn-outline-light text-secondary border-0">âœ•</button>
                </li>`;
        });

        // 4. çµç®—
        const peopleCount = d.participants.length;
        const avgCost = peopleCount > 0 ? totalCost / peopleCount : 0;
        document.getElementById('totalCost').innerText = totalCost;
        document.getElementById('peopleCountDisplay').innerText = peopleCount;
        document.getElementById('avgCost').innerText = Math.round(avgCost);

        const balList = document.getElementById('balanceList');
        balList.innerHTML = '';
        
        d.participants.forEach((p, index) => {
            const paid = d.expenses.filter(e => e.payer === p.name).reduce((sum, e) => sum + Number(e.cost), 0);
            const balance = paid - avgCost;
            
            let balanceUi = '';
            if (balance > 1) balanceUi = `<span class="balance-plus">æ‡‰æ”¶ $${Math.round(balance)}</span>`;
            else if (balance < -1) balanceUi = `<span class="balance-minus">æ‡‰ä»˜ $${Math.round(Math.abs(balance))}</span>`;
            else balanceUi = `<span class="text-muted">å¹³å¸³</span>`;

            balList.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <div>
                        <div class="fw-bold fs-5">${p.name}</div>
                        <small class="text-muted">å·²å¢Šä»˜ $${paid}</small>
                    </div>
                    <div class="text-end">
                        <div class="mb-2">${balanceUi}</div>
                        <button onclick="togglePaid(${index})" class="btn btn-sm ${p.status === 'paid' ? 'btn-success' : 'btn-outline-secondary'} rounded-pill px-3">
                            ${p.status === 'paid' ? 'âœ… å·²çµæ¸…' : 'ç­‰å¾…ä»˜æ¬¾'}
                        </button>
                    </div>
                </li>`;
        });
    }

    // --- å¯«å…¥é‚è¼¯ ---
    async function addParticipant() {
        const name = document.getElementById('newPerson').value;
        if(!name) return;
        await updateDoc(doc(db, "trips", currentTripId), { participants: arrayUnion({ name: name, status: 'unpaid' }) });
        document.getElementById('newPerson').value = '';
    }

    async function addExpense() {
        const item = document.getElementById('expItem').value;
        const cost = document.getElementById('expCost').value;
        const payer = document.getElementById('expPayer').value;
        if(!item || !cost || payer === 'èª°ä»˜éŒ¢?') return alert("è³‡æ–™ä¸å®Œæ•´");
        await updateDoc(doc(db, "trips", currentTripId), { expenses: arrayUnion({ item, cost: Number(cost), payer }) });
        document.getElementById('expItem').value = '';
        document.getElementById('expCost').value = '';
    }

    async function addGear() {
        const item = document.getElementById('gearItem').value;
        const qty = document.getElementById('gearQty').value;
        const provider = document.getElementById('gearProvider').value;
        if(!item || provider === 'èª°æä¾›?') return alert("è³‡æ–™ä¸å®Œæ•´");
        await updateDoc(doc(db, "trips", currentTripId), { gears: arrayUnion({ item, quantity: Number(qty) || 1, provider }) });
        document.getElementById('gearItem').value = '';
        document.getElementById('gearQty').value = '1';
    }

    async function deleteItemFromArray(field, index) {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        const newList = [...currentTripData[field]];
        newList.splice(index, 1);
        await updateDoc(doc(db, "trips", currentTripId), { [field]: newList });
    }

    async function deleteParticipant(index) {
        const name = currentTripData.participants[index].name;
        if(currentTripData.expenses.some(e => e.payer === name)) return alert(`ç„¡æ³•åˆªé™¤ ${name}ï¼Œå› ç‚ºä»–æœ‰ä»˜æ¬¾ç´€éŒ„ã€‚`);
        await deleteItemFromArray('participants', index);
    }
    async function deleteExpense(index) { await deleteItemFromArray('expenses', index); }
    async function deleteGear(index) { await deleteItemFromArray('gears', index); }

    async function togglePaid(index) {
        const newParticipants = [...currentTripData.participants];
        newParticipants[index].status = newParticipants[index].status === 'paid' ? 'unpaid' : 'paid';
        await updateDoc(doc(db, "trips", currentTripId), { participants: newParticipants });
    }
</script>
</body>
</html>